
name: Growatt – Export Limit via tcpSet.do

on:
  workflow_dispatch:
    inputs:
      enable:
        description: "Enable (1) or Disable (0) Export Limit"
        required: true
        default: "1"
        type: choice
        options: ["1", "0"]

permissions:
  contents: write  # needed to commit package-lock.json on first run

jobs:
  write-backflow-setting:
    runs-on: ubuntu-latest
    concurrency:
      group: growatt-exportlimit
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Create a lockfile the first time so later runs can use `npm ci`
      - name: Ensure lockfile
        id: lock
        run: |
          if [ ! -f package-lock.json ]; then
            echo "No package-lock.json found. Generating…"
            npm install --package-lock-only
            echo "created=true" >> $GITHUB_OUTPUT
          else
            echo "created=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit lockfile (first run only)
        if: steps.lock.outputs.created == 'true'
        uses: EndBug/add-and-commit@v9
        with:
          add: 'package-lock.json'
          message: 'chore: add package-lock.json (auto)'
          default_author: github_actions

      - name: Install dependencies
        run: |
          if [ "${{ steps.lock.outputs.created }}" = "true" ]; then
            npm install
          else
            npm ci
          fi

      # Map TL‑X backflow payload from the "enable" input:
      # Enable  -> param1=1, param2=0, param3=1
      # Disable -> param1=0, param2=0, param3=0
      - name: Prepare param1/2/3 from input
        id: prep
        run: |
          if [ "${{ github.event.inputs.enable }}" = "1" ]; then
            echo "P1=1" >> $GITHUB_OUTPUT
            echo "P2=0" >> $GITHUB_OUTPUT
            echo "P3=1" >> $GITHUB_OUTPUT
          else
            echo "P1=0" >> $GITHUB_OUTPUT
            echo "P2=0" >> $GITHUB_OUTPUT
            echo "P3=0" >> $GITHUB_OUTPUT
          fi

      - name: tcpSet.do backflow_setting (tlxSet)
        env:
          # --- Login (set these as repo secrets) ---
          GROWATT_USERNAME: ${{ secrets.GROWATT_USERNAME }}
          GROWATT_PASSWORD: ${{ secrets.GROWATT_PASSWORD }}

          # --- TL‑X payload from your DevTools capture ---
          GW_TCPSET_ACTION: tlxSet
          GW_TCPSET_TYPE: backflow_setting
          GW_TCPSET_SN_KEY: serialNum
          # Keep the serial number as a secret for safety:
          GW_TCPSET_SN_VALUE: ${{ secrets.GW_TCPSET_SN_VALUE }}

          # Per-run params (derived from workflow input)
          GW_TCPSET_PARAM1: ${{ steps.prep.outputs.P1 }}
          GW_TCPSET_PARAM2: ${{ steps.prep.outputs.P2 }}
          GW_TCPSET_PARAM3: ${{ steps.prep.outputs.P3 }}

          # --- Exact Referer you reported (Request Headers -> Referer) ---
          GW_TCPSET_REFERER: https://server.growatt.com/tcpSet.do

          # --- Optional: override base if your account uses another host (keep default otherwise) ---
          # GW_SERVER_BASE: https://server.growatt.com

          # --- Optional: provide explicit password (not needed; script auto-builds growattYYYYMMDD) ---
          # GW_TCPSET_ADV_PWD: ${{ secrets.GW_TCPSET_ADV_PWD }}

          # --- Optional: disable auto daily password (debug only) ---
          # GW_TCPSET_NO_AUTO_PWD: 'true'
        run: node enable-exportlimit-tcpSet.mjs
