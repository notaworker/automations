
name: Growatt – Export Limit via tcpSet.do

on:
  workflow_dispatch:
    inputs:
      enable:
        description: "Enable (1) or Disable (0) Export Limit"
        required: true
        default: "1"
        type: choice
        options: ["1", "0"]

permissions:
  contents: write

jobs:
  write-register-202:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Create lockfile on first run (no cache first time)
      - name: Ensure lockfile
        id: lock
        run: |
          if [ ! -f package-lock.json ]; then
            npm install --package-lock-only
            echo "created=true" >> $GITHUB_OUTPUT
          else
            echo "created=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit lockfile
        if: steps.lock.outputs.created == 'true'
        uses: EndBug/add-and-commit@v9
        with:
          add: 'package-lock.json'
          message: 'chore: add package-lock.json (auto)'
          default_author: github_actions

      - name: Install deps
        run: |
          if [ "${{ steps.lock.outputs.created }}" = "true" ]; then
            npm install
          else
            npm ci
          fi

      - name: Set tcpSet parameters from input (202 = enable/disable)
        id: prep
        run: |
          if [ "${{ github.event.inputs.enable }}" = "1" ]; then
            echo 'PARAMS=["202","1"]' >> $GITHUB_OUTPUT
          else
            echo 'PARAMS=["202","0"]' >> $GITHUB_OUTPUT
          fi

      - name: Call tcpSet.do (register 202 → 1/0)
        env:
          GROWATT_USERNAME: ${{ secrets.GROWATT_USERNAME }}
          GROWATT_PASSWORD: ${{ secrets.GROWATT_PASSWORD }}
          GROWATT_DEVICE_SN: ${{ secrets.GROWATT_DEVICE_SN }}

          # Required (copy from your DevTools capture; see step 3 below)
          GW_TCPSET_ACTION: ${{ secrets.GW_TCPSET_ACTION }}
          GW_TCPSET_TYPE:   ${{ secrets.GW_TCPSET_TYPE }}

          # Parameters are set from the workflow input (enable/disable)
          GW_TCPSET_PARAMETERS: ${{ steps.prep.outputs.PARAMS }}

          # Optional (only if your DevTools request shows them)
          GW_TCPSET_ADV_PWD:     ${{ secrets.GW_TCPSET_ADV_PWD }}
          GW_TCPSET_SN_KEY:      ${{ secrets.GW_TCPSET_SN_KEY }}
          GW_TCPSET_SN_VALUE:    ${{ secrets.GW_TCPSET_SN_VALUE }}
          GW_TCPSET_PLANT_KEY:   ${{ secrets.GW_TCPSET_PLANT_KEY }}
          GW_TCPSET_PLANT_VALUE: ${{ secrets.GW_TCPSET_PLANT_VALUE }}
        run: node enable-exportlimit-tcpSet.mjs
