
name: Growatt – Toggle Export Limit

on:
  workflow_dispatch:
    inputs:
      enable:
        description: "Enable (1) or Disable (0) Export Limit"
        required: true
        default: "1"
        type: choice
        options: ["1", "0"]

permissions:
  contents: write

jobs:
  toggle-export-limit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (no cache on first run)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Ensure lockfile exists (create if missing)
        id: lock
        run: |
          if [ ! -f package-lock.json ]; then
            echo "No package-lock.json found. Generating…"
            npm install --package-lock-only
            echo "created=true" >> $GITHUB_OUTPUT
          else
            echo "created=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit lockfile (first run only)
        if: steps.lock.outputs.created == 'true'
        uses: EndBug/add-and-commit@v9
        with:
          add: 'package-lock.json'
          message: 'chore: add package-lock.json (auto)'
          default_author: github_actions

      - name: Setup Node (with cache after lockfile exists)
        if: steps.lock.outputs.created == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: |
          if [ "${{ steps.lock.outputs.created }}" = "true" ]; then
            npm install
          else
            npm ci
          fi

      - name: Try to toggle Export Limit
        id: toggle
        continue-on-error: true
        env:
          GROWATT_USERNAME: ${{ secrets.GROWATT_USERNAME }}
          GROWATT_PASSWORD: ${{ secrets.GROWATT_PASSWORD }}
          GROWATT_DEVICE_SN: ${{ secrets.GROWATT_DEVICE_SN }}
          GROWATT_SERVER_BASE: https://server.growatt.com
          EXPORT_LIMIT_ENABLE: ${{ github.event.inputs.enable }}
          # If you already know them, you can set overrides here:
          # GROWATT_FUNC: "writeRegister"
          # GROWATT_REG_PARAM: "reg"
          # GROWATT_VAL_PARAM: "val"
        run: node set-export-limit.mjs

      - name: If toggle failed, list available functions/params
        if: steps.toggle.outcome == 'failure'
        env:
          GROWATT_USERNAME: ${{ secrets.GROWATT_USERNAME }}
          GROWATT_PASSWORD: ${{ secrets.GROWATT_PASSWORD }}
          GROWATT_DEVICE_SN: ${{ secrets.GROWATT_DEVICE_SN }}
          GROWATT_SERVER_BASE: https://server.growatt.com
        run: node list-functions.mjs

      - name: Guidance
        if: steps.toggle.outcome == 'failure'
        run: |
          echo "Auto-detect couldn't find a write-register function for your TL-X firmware."
          echo "Check the 'list-functions' step output above."
          echo "Set these repo-level variables in the 'Toggle Export Limit' step:"
          echo "  GROWATT_FUNC=<the function name printed>"
          echo "  GROWATT_REG_PARAM=<the key for register index>"
          echo "  GROWATT_VAL_PARAM=<the key for register value>"
          echo "Then re-run the workflow."
