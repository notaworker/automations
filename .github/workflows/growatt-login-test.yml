
name: Growatt Login Test

on:
  workflow_dispatch:
    inputs:
      server_base:
        description: "Optional: Override server base (e.g., https://shineserver.growatt.com)"
        required: false
        default: ""
  # Uncomment if you want a scheduled check (e.g., daily at 07:05 CET)
  # schedule:
  #   - cron: '5 6 * * *'

permissions:
  contents: read

concurrency:
  group: growatt-login-${{ github.ref }}
  cancel-in-progress: false

jobs:
  test-login:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        # Default hosts to try; will be overridden when workflow_dispatch input is set
        server_base:
          - https://shineserver.growatt.com
          - https://server.growatt.com

    env:
      # Use the matrix host unless an explicit workflow input was provided
      GW_SERVER_BASE: ${{ github.event.inputs.server_base != '' && github.event.inputs.server_base || matrix.server_base }}
      GW_USER: ${{ secrets.GW_USER }}
      GW_PASS: ${{ secrets.GW_PASS }}
      GW_VALIDATE_CODE: ${{ secrets.GW_VALIDATE_CODE }}

    steps:
      - name: üßæ Checkout
      # If your script is already in the repo, keep checkout. If not, remove and add a step to create the file.
        uses: actions/checkout@v4

      - name: üîí Mask sensitive values in logs
        run: |
          echo "::add-mask::${GW_USER}"
          echo "::add-mask::${GW_PASS}"
          if [ -n "${GW_VALIDATE_CODE}" ]; then
            echo "::add-mask::${GW_VALIDATE_CODE}"
          fi

      - name: üü¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: |
          npm ci || npm install
          # Ensure required deps exist even if not listed in package.json
          npm ls axios axios-cookiejar-support tough-cookie >/dev/null 2>&1 || npm i axios axios-cookiejar-support tough-cookie

      # OPTIONAL: If you want to ensure the latest script content is present,
      # replace the file creation step below with your own content commit.
      # - name: Ensure script exists (skip if already committed to repo)
      #   shell: bash
      #   run: |
      #     test -f growatt-login-test.mjs && exit 0
      #     echo "‚ùå growatt-login-test.mjs not found in repo. Commit it or generate it here."
      #     exit 1

      - name: ‚ñ∂Ô∏è Run login flow against ${{ env.GW_SERVER_BASE }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p logs
          # Create a safe filename per host
          SAFE_NAME="$(echo "${GW_SERVER_BASE}" | sed 's/[^a-zA-Z0-9]/_/g')"
          LOG_FILE="logs/login_${SAFE_NAME}.log"

          echo "Testing host: ${GW_SERVER_BASE}"
          echo "Writing log to: ${LOG_FILE}"
          # Run the test; capture output to a log while preserving exit code
          set +e
          node growatt-login-test.mjs | tee "${LOG_FILE}"
          CODE=${PIPESTATUS[0]}
          set -e

          if [ $CODE -ne 0 ]; then
            echo "‚ùå Script exited with code $CODE"
          else
            echo "‚úÖ Script completed successfully"
          fi

          # Surface the exit code to the job
          exit $CODE

      - name: ‚¨ÜÔ∏è Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: growatt-login-logs-${{ github.run_id }}
          path: logs/
          if-no-files-found: warn
