
name: Growatt â€“ Login Test

on:
  workflow_dispatch: {}

jobs:
  login-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Ensure lockfile
        id: lock
        run: |
          if [ ! -f package-lock.json ]; then
            npm install --package-lock-only
            echo "created=true" >> $GITHUB_OUTPUT
          else
            echo "created=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit lockfile (first run only)
        if: steps.lock.outputs.created == 'true'
        uses: EndBug/add-and-commit@v9
        with:
          add: 'package-lock.json'
          message: 'chore: add package-lock.json (auto)'
          default_author: github_actions

      - name: Install deps
        run: |
          if [ "${{ steps.lock.outputs.created }}" = "true" ]; then
            npm install
          else
            npm ci
          fi

      - name: Login test
        env:
          GROWATT_USERNAME: ${{ secrets.GROWATT_USERNAME }}
          GROWATT_PASSWORD: ${{ secrets.GROWATT_PASSWORD }}
          # Optional: set if your account uses another host (e.g., server-us.growatt.com or server.smten.com)
          # GW_SERVER_BASE: https://server.growatt.com
        run: node growatt-login-test.mjs
