
name: Growatt Login Test

on:
  workflow_dispatch:
    inputs:
      server_base:
        description: "Optional: Override server base (e.g., https://server.growatt.com)"
        required: false
        default: ""
  # Optional schedule (CET 07:05 daily)
  # schedule:
  #   - cron: '5 6 * * *'

permissions:
  contents: read

concurrency:
  group: growatt-login-${{ github.ref }}
  cancel-in-progress: false

jobs:
  test-login:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        server_base:
          - https://server.growatt.com

    # Map your secrets to the env vars the scripts use
    env:
      GW_SERVER_BASE: ${{ github.event.inputs.server_base != '' && github.event.inputs.server_base || matrix.server_base }}
      GW_USER: ${{ secrets.GROWATT_USERNAME }}
      GW_PASS: ${{ secrets.GROWATT_PASSWORD }}
      GW_DEVICE_SN: ${{ secrets.GROWATT_DEVICE_SN }}
      # Only needed if your account is currently showing captcha
      GW_VALIDATE_CODE: ${{ secrets.GW_VALIDATE_CODE }}

    steps:
      - name: üßæ Checkout
        uses: actions/checkout@v4

      - name: üîí Mask sensitive values
        run: |
          [ -n "${GW_USER}" ] && echo "::add-mask::${GW_USER}"
          [ -n "${GW_PASS}" ] && echo "::add-mask::${GW_PASS}"
          [ -n "${GW_VALIDATE_CODE}" ] && echo "::add-mask::${GW_VALIDATE_CODE}"
          [ -n "${GW_DEVICE_SN}" ] && echo "::add-mask::${GW_DEVICE_SN}"

      - name: üü¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install runtime dependencies (no package.json changes)
        run: |
          # Install required runtime deps regardless of package.json
          npm install --no-save axios axios-cookiejar-support tough-cookie cheerio

      # Make a filesystem-safe key from the server base for log/artifact names
      - name: üßπ Sanitize server base for filenames
        id: sanitize
        shell: bash
        run: |
          SAFE="$(echo "${GW_SERVER_BASE}" | sed -E 's~^https?://~~; s~[^A-Za-z0-9._-]~_~g')"
          echo "safe=${SAFE}" >> "$GITHUB_OUTPUT"
          echo "Using safe host key: ${SAFE}"

      - name: üß™ Run login flow against ${{ env.GW_SERVER_BASE }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${GW_USER}" ] || [ -z "${GW_PASS}" ]; then
            echo "‚ùå GW_USER or GW_PASS is empty. Ensure repo/org secrets GROWATT_USERNAME and GROWATT_PASSWORD are set and available to this run."
            exit 2
          fi
          mkdir -p logs
          LOG_FILE="logs/login_${{ steps.sanitize.outputs.safe }}.log"
          echo "Testing host: ${GW_SERVER_BASE}"
          echo "Writing log to: ${LOG_FILE}"
          set +e
          node growatt-login-test.mjs | tee "${LOG_FILE}"
          CODE=${PIPESTATUS[0]}
          set -e
          echo "Exit code: $CODE"
          exit $CODE

      - name: ‚¨ÜÔ∏è Upload logs (unique + sanitized name)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: growatt-login-logs-${{ github.run_id }}-${{ steps.sanitize.outputs.safe }}
          path: logs/
          if-no-files-found: warn
          overwrite: true
