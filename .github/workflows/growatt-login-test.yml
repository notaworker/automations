
name: Growatt Login Test

on:
  workflow_dispatch:
    inputs:
      server_base:
        description: "Optional: Override server base (e.g., https://shineserver.growatt.com)"
        required: false
        default: ""
  # Optional schedule (CET 07:05 daily)
  # schedule:
  #   - cron: '5 6 * * *'

permissions:
  contents: read

concurrency:
  group: growatt-login-${{ github.ref }}
  cancel-in-progress: false

jobs:
  test-login:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        server_base:
          - https://shineserver.growatt.com
          - https://server.growatt.com

    env:
      GW_SERVER_BASE: ${{ github.event.inputs.server_base != '' && github.event.inputs.server_base || matrix.server_base }}
      GW_USER: ${{ secrets.GW_USER }}
      GW_PASS: ${{ secrets.GW_PASS }}
      GW_VALIDATE_CODE: ${{ secrets.GW_VALIDATE_CODE }}

    steps:
      - name: üßæ Checkout
        uses: actions/checkout@v4

      - name: üîí Mask sensitive values
        run: |
          echo "::add-mask::${GW_USER}"
          echo "::add-mask::${GW_PASS}"
          if [ -n "${GW_VALIDATE_CODE}" ]; then
            echo "::add-mask::${GW_VALIDATE_CODE}"
          fi

      - name: üü¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: |
          npm ci || npm install
          npm ls axios axios-cookiejar-support tough-cookie >/dev/null 2>&1 || npm i axios axios-cookiejar-support tough-cookie

      - name: ‚ñ∂Ô∏è Run login flow against ${{ env.GW_SERVER_BASE }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p logs
          SAFE_NAME="$(echo "${GW_SERVER_BASE}" | sed 's/[^a-zA-Z0-9]/_/g')"
          LOG_FILE="logs/login_${SAFE_NAME}.log"
          echo "Testing host: ${GW_SERVER_BASE}"
          set +e
          node growatt-login-test.mjs | tee "${LOG_FILE}"
          CODE=${PIPESTATUS[0]}
          set -e
          echo "Exit code: $CODE"
          exit $CODE

      - name: ‚¨ÜÔ∏è Upload logs (unique per host)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: growatt-login-logs-${{ github.run_id }}-${{ matrix.server_base }}
          path: logs/
          if-no-files-found: warn
