
name: Export Limit (tcpSet.do)

on:
  workflow_dispatch:
    inputs:
      server_base:
        description: "Portal host (e.g., https://shineserver.growatt.com or https://server.growatt.com)"
        required: false
        default: "https://shineserver.growatt.com"
      param1:
        description: "param1 (required) ‚Äì e.g., export limit value"
        required: true
        default: ""
      param2:
        description: "param2 (optional)"
        required: false
        default: ""
      param3:
        description: "param3 (optional)"
        required: false
        default: ""
      referer:
        description: "Referer URL (recommended: the exact page that fired tcpSet.do)"
        required: false
        default: ""
      adv_pwd:
        description: "Installer/Advanced password (optional)"
        required: false
        default: ""
      no_auto_pwd:
        description: "Set to true to DISABLE daily password attempts"
        required: false
        default: "false"

permissions:
  contents: read

concurrency:
  group: export-limit-${{ github.ref }}
  cancel-in-progress: false

jobs:
  export-limit:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      GW_SERVER_BASE: ${{ github.event.inputs.server_base }}

      # ‚úÖ map to your secret names
      GW_USER: ${{ secrets.GROWATT_USERNAME }}
      GW_PASS: ${{ secrets.GROWATT_PASSWORD }}
      GW_DEVICE_SN: ${{ secrets.DEVICE_SN }}

      # optional captcha if currently required
      GW_VALIDATE_CODE: ${{ secrets.GW_VALIDATE_CODE }}

      # tcpSet.do required fields (adjust only if your capture differs)
      GW_TCPSET_ACTION: tlxSet
      GW_TCPSET_TYPE: backflow_setting
      GW_TCPSET_SN_KEY: serialNum
      GW_TCPSET_SN_VALUE: ${{ secrets.DEVICE_SN }}
      GW_TCPSET_PARAM1: ${{ github.event.inputs.param1 }}
      GW_TCPSET_PARAM2: ${{ github.event.inputs.param2 }}
      GW_TCPSET_PARAM3: ${{ github.event.inputs.param3 }}
      GW_TCPSET_REFERER: ${{ github.event.inputs.referer }}

      # Optional advanced password flow controls
      GW_TCPSET_ADV_PWD: ${{ github.event.inputs.adv_pwd }}
      GW_TCPSET_NO_AUTO_PWD: ${{ github.event.inputs.no_auto_pwd }}

    steps:
      - name: üßæ Checkout
        uses: actions/checkout@v4

      - name: üîí Mask sensitive values
        run: |
          [ -n "${GW_USER}" ] && echo "::add-mask::${GW_USER}"
          [ -n "${GW_PASS}" ] && echo "::add-mask::${GW_PASS}"
          [ -n "${GW_DEVICE_SN}" ] && echo "::add-mask::${GW_DEVICE_SN}"
          [ -n "${GW_VALIDATE_CODE}" ] && echo "::add-mask::${GW_VALIDATE_CODE}"
          [ -n "${GW_TCPSET_ADV_PWD}" ] && echo "::add-mask::${GW_TCPSET_ADV_PWD}"

      - name: üü¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: |
          npm ci || npm install
          npm ls axios axios-cookiejar-support tough-cookie cheerio >/dev/null 2>&1 || npm i axios axios-cookiejar-support tough-cookie cheerio

      - name: üßπ Sanitize host for filenames
        id: sanitize
        shell: bash
        run: |
          SAFE="$(echo "${GW_SERVER_BASE}" | sed -E 's~^https?://~~; s~[^A-Za-z0-9._-]~_~g')"
          echo "safe=${SAFE}" >> "$GITHUB_OUTPUT"
          echo "Using safe host key: ${SAFE}"

      - name: üß™ Run export-limit tcpSet
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${GW_USER}" ] || [ -z "${GW_PASS}" ]; then
            echo "‚ùå Missing credentials. Set repo secrets GROWATT_USERNAME and GROWATT_PASSWORD."
            exit 2
          fi
          if [ -z "${GW_DEVICE_SN}" ]; then
            echo "‚ùå Missing device SN. Set repo secret DEVICE_SN."
            exit 2
          fi
          if [ -z "${GW_TCPSET_PARAM1}" ]; then
            echo "‚ùå Missing param1 (required). Provide via workflow input."
            exit 2
          fi

          mkdir -p logs
          LOG_FILE="logs/tcpset_${{ steps.sanitize.outputs.safe }}.log"
          echo "Portal:     ${GW_SERVER_BASE}"
          echo "Device SN:  ${GW_DEVICE_SN}"
          echo "Action:     ${GW_TCPSET_ACTION}"
          echo "Type:       ${GW_TCPSET_TYPE}"
          echo "SN key:     ${GW_TCPSET_SN_KEY}"
          echo "Params:     param1='${GW_TCPSET_PARAM1}' param2='${GW_TCPSET_PARAM2}' param3='${GW_TCPSET_PARAM3}'"
          echo "Referer:    ${GW_TCPSET_REFERER:-<default /index>}"
          echo "Adv pwd?:   $([ -n "${GW_TCPSET_ADV_PWD}" ] && echo yes || echo no)"
          echo "Daily pwd?: $([ "${GW_TCPSET_NO_AUTO_PWD}" = "true" ] && echo disabled || echo enabled)"
          echo "Log file:   ${LOG_FILE}"
          echo ""

          set +e
          node enable-exportlimit-tcpSet.mjs | tee "${LOG_FILE}"
          CODE=${PIPESTATUS[0]}
          set -e
          echo "Exit code: ${CODE}"
          exit ${CODE}

      - name: ‚¨ÜÔ∏è Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: export-limit-${{ github.run_id }}-${{ steps.sanitize.outputs.safe }}
          path: logs/
          if-no-files-found: warn
          overwrite: true
